@page
@model UI.Pages.Documents.DocumentsModel
@{
    ViewData["Title"] = "Documents";
}

<div class="animate-fade-in">
    <div class="d-flex justify-between align-center mb-4">
        <h1>Documents</h1>
        <a href="/" class="btn btn-primary"><i class="fas fa-plus"></i> Upload</a>
    </div>

    <!-- Search & Filter Bar -->
    <div class="card d-flex gap-4 align-center mb-4" style="padding: 0.75rem;">
        <div class="d-flex align-center gap-2" style="flex: 1;">
            <i class="fas fa-search text-muted"></i>
            <input type="text" id="searchInput" class="form-control" style="background: transparent; border: none;" placeholder="Search by name, content, or tag...">
        </div>
        <div style="border-left: 1px solid var(--border-color); height: 24px;"></div>
        <select class="form-control" style="width: auto; background: transparent; border: none; color: var(--text-secondary);">
            <option>Sort by Date</option>
            <option>Sort by Name</option>
        </select>
    </div>

    <!-- Documents Grid -->
    <div class="dashboard-grid" id="documentsGrid">
        <!-- Injected via JS -->
        <p class="text-muted">Loading...</p>
    </div>
</div>

<script>
    let allDocs = [];

    async function loadDocuments() {
        try {
            const res = await fetch('http://localhost:8081/api/document');
            allDocs = await res.json();
            renderDocs(allDocs);
        } catch (e) {
            console.error(e);
            document.getElementById('documentsGrid').innerHTML = '<p class="text-danger">Failed to load documents.</p>';
        }
    }

    function renderDocs(docs) {
        const grid = document.getElementById('documentsGrid');
        
        // Change grid to list layout
        grid.style.display = 'flex';
        grid.style.flexDirection = 'column';
        grid.style.gap = '1rem';

        if (docs.length === 0) {
            grid.innerHTML = '<p class="text-muted">No documents found.</p>';
            return;
        }

        grid.innerHTML = docs.map(doc => `
             <div class="card d-flex flex-row gap-4 p-0 overflow-hidden" onclick="window.location.href='/Details?id=${doc.id}'" style="cursor: pointer; height: 200px; transition: transform 0.2s; align-items: stretch;">
                
                <!-- Left: Preview -->
                <div style="background: #27272a; width: 200px; min-width: 200px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border-right: 1px solid var(--border-color);">
                     <canvas id="thumb-${doc.id}" style="width: 100%; object-fit: contain;"></canvas>
                     <div id="loading-${doc.id}" class="text-muted" style="position: absolute; font-size: 0.8rem;">Loading...</div>
                </div>
                
                <!-- Right: Info -->
                <div class="d-flex flex-col justify-between p-3 flex-1" style="min-width: 0;">
                    <div>
                        <div class="d-flex justify-between align-start gap-2">
                            <h4 style="margin: 0; font-size: 1.15rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${doc.fileName}">${doc.fileName}</h4>
                            <span class="text-muted" style="font-size: 0.85rem; flex-shrink: 0;">${new Date(doc.uploadedAt).toLocaleDateString()}</span>
                        </div>
                        
                        <div class="mt-2 text-muted" style="font-size: 0.9rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 3em;">
                             ${doc.ocrText ? doc.ocrText.substring(0, 300) : 'No preview text available.'}
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-3" style="flex-wrap: wrap;">
                        ${(doc.tags || []).map(t => `
                            <span class="badge" style="background-color: ${t.color || 'var(--secondary)'}; color: ${t.color ? '#fff' : 'inherit'};">
                                ${t.name}
                            </span>
                        `).join('')}
                    </div>
                </div>
            </div>
        `).join('');
        
        // Trigger Generation
        docs.forEach(doc => generateThumbnail(doc.id));
    }
    
    // Thumbnail Logic (Duplicated from Dashboard for simplicity, ideally in app.js but contexts differ slightly)
    async function generateThumbnail(docId) {
        try {
            const url = `http://localhost:8081/api/document/${docId}/download`;
            const loadingTask = pdfjsLib.getDocument(url);
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);
            
            const scale = 0.4; // Smaller for list
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.getElementById(`thumb-${docId}`);
            if(!canvas) return;

            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;
            
            const loadingEl = document.getElementById(`loading-${docId}`);
            if(loadingEl) loadingEl.style.display = 'none';

        } catch (e) {
            // Fallback
             const canvas = document.getElementById(`thumb-${docId}`);
           if(canvas) {
                const parent = canvas.parentElement;
                parent.innerHTML = '<i class="fas fa-file-pdf text-accent" style="font-size: 2rem;"></i>';
           }
        }
    }

    // Search Logic
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allDocs.filter(d => 
            d.fileName.toLowerCase().includes(term) || 
            (d.ocrText && d.ocrText.toLowerCase().includes(term))
        );
        renderDocs(filtered);
    });

    // Check for search query param
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    if (searchParam) {
        searchInput.value = searchParam;
        // Logic will trigger after fetch
    }

    loadDocuments().then(() => {
        if (searchParam) searchInput.dispatchEvent(new Event('input'));
    });
</script>