@page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="animate-fade-in">
    <!-- Hero / Drag Drop Zone -->
    <div class="mb-4">
        <div id="dropZone" class="card d-flex flex-col align-center justify-center text-center"
             style="height: 300px; border: 2px dashed var(--border-color); background: radial-gradient(circle at center, rgba(245, 158, 11, 0.05), transparent 70%); cursor: pointer;">
            <i class="fas fa-cloud-upload-alt mb-2" style="font-size: 3rem; color: var(--accent-primary);"></i>
            <h2 class="mb-2">Drag & Drop to Upload</h2>
            <p class="text-muted mb-4">or click to browse your files</p>
            <button class="btn btn-primary"
                    onclick="event.stopPropagation(); document.getElementById('fileInput').click()">Browse Files
            </button>
            <input type="file" id="fileInput" hidden multiple accept=".pdf,.png,.jpg,.jpeg">
        </div>
    </div>

    <!-- Recent Documents -->
    <div class="d-flex align-center justify-between mb-4">
        <h3>Recent Documents</h3>
    </div>
    <div id="recentDocsGrid"
         style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
        <!-- Grid Items -->
    </div>
</div>
<!-- Upload Preview Modal -->
<div id="uploadModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center;">
    <div class="card" style="width: 500px; max-width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="d-flex justify-between align-center mb-4">
            <h3 style="margin: 0;">Confirm Upload</h3>
            <button class="btn btn-secondary p-0" style="width: 30px; height: 30px;" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div id="uploadList"
             style="flex: 1; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
            <!-- Items injected here -->
        </div>

        <div id="uploadProgress" class="mb-3" style="display: none;">
            <div style="height: 6px; background: var(--secondary); border-radius: 3px; overflow: hidden;">
                <div id="progressBar"
                     style="width: 0%; height: 100%; background: var(--accent-primary); transition: width 0.3s;"></div>
            </div>
        </div>

        <div class="d-flex justify-between align-center">
            <span id="fileCount" class="text-muted">0 files selected</span>
            <button class="btn btn-primary" onclick="confirmUpload()">
                <i class="fas fa-cloud-upload-alt"></i> Upload All
            </button>
        </div>
    </div>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadModal = document.getElementById('uploadModal');
    let filesToUpload = [];

    // Drag & Drop Events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.style.borderColor = 'var(--accent-primary)', false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.style.borderColor = 'var(--border-color)', false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function () {
        handleFiles(this.files);
    });

    function handleDrop(e) {
        const dt = e.dataTransfer;
        handleFiles(dt.files);
    }

    function handleFiles(files) {
        if (files.length > 0) {
            filesToUpload = Array.from(files);
            showModal();
        }
    }

    function showModal() {
        const list = document.getElementById('uploadList');
        list.innerHTML = filesToUpload.map((f, i) => `
            <div class="d-flex align-center gap-2 p-2" style="border-bottom: 1px solid var(--border-color);">
                <i class="fas fa-file-pdf text-accent" style="font-size: 1.5rem;"></i>
                <div style="flex: 1; overflow: hidden;">
                    <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                    <div class="text-muted" style="font-size: 0.8rem;">${(f.size / 1024 / 1024).toFixed(2)} MB</div>
                </div>
                <button class="btn btn-secondary" style="color: var(--danger);" onclick="removeFile(${i})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');

        document.getElementById('fileCount').innerText = `${filesToUpload.length} files selected`;
        uploadModal.style.display = 'flex';
    }

    function removeFile(index) {
        filesToUpload.splice(index, 1);
        if (filesToUpload.length === 0) {
            closeModal();
        } else {
            showModal();
        }
    }

    function closeModal() {
        uploadModal.style.display = 'none';
        filesToUpload = [];
        fileInput.value = ''; // Reset input
    }

    async function confirmUpload() {
        if (filesToUpload.length === 0) return;

        const btn = document.querySelector('#uploadModal .btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        btn.disabled = true;

        document.getElementById('uploadProgress').style.display = 'block';
        const progressBar = document.getElementById('progressBar');

        let successCount = 0;
        const total = filesToUpload.length;

        for (let i = 0; i < total; i++) {
            const formData = new FormData();
            formData.append('File', filesToUpload[i]);

            try {
                const res = await fetch('http://localhost:8081/api/document', {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) successCount++;
            } catch (e) {
                console.error(e);
            }

            progressBar.style.width = `${((i + 1) / total) * 100}%`;
        }

        btn.innerHTML = originalText;
        btn.disabled = false;
        closeModal();
        document.getElementById('uploadProgress').style.display = 'none';
        progressBar.style.width = '0%';

        loadDashboard();
    }

    // Dashboard Logic
    async function loadDashboard() {
        try {
            const res = await fetch('http://localhost:8081/api/document');
            const docs = await res.json();

            // Recent docs logic
            const recentDocs = docs.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt)).slice(0, 8);

            const grid = document.getElementById('recentDocsGrid');
            if (recentDocs.length === 0) {
                grid.innerHTML = '<p class="text-muted">No documents found.</p>';
                return;
            }

            grid.innerHTML = recentDocs.map(doc => `
                <div class="card" onclick="window.location.href='/Details?id=${doc.id}'" style="cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column;">
                     <!-- Zoomed Preview Section -->
                    <div style="height: 180px; width: 100%; background: #27272a; overflow: hidden; position: relative; border-bottom: 1px solid var(--border-color);">
                        <canvas id="thumb-${doc.id}" style="width: 100%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); transform-origin: top center;"></canvas>
                         <div id="loading-${doc.id}" class="text-muted" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">Loading...</div>
                    </div>

                    <div class="d-flex flex-col gap-2 p-2" style="padding-top: 0.5rem;">
                        <h4 style="margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1rem;" title="${doc.fileName}">${doc.fileName}</h4>
                        <span class="text-muted" style="font-size: 0.8rem;">${new Date(doc.uploadedAt).toLocaleDateString()}</span>
                        <div class="d-flex gap-2" style="flex-wrap: wrap;">
                            ${(doc.tags || []).map(t => `<span class="badge">${t.name || t}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');

            // Trigget thumbnail generation
            recentDocs.forEach(doc => generateThumbnail(doc.id));

        } catch (e) {
            console.error(e);
        }
    }

    async function generateThumbnail(docId) {
        try {
            const url = `http://localhost:8081/api/document/${docId}/download`;
            const loadingTask = pdfjsLib.getDocument(url);
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);

            // Render at high quality, then CSS scales it down to fit/zoom
            const scale = 1.0;
            const viewport = page.getViewport({scale: scale});
            const canvas = document.getElementById(`thumb-${docId}`);
            if (!canvas) return;

            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;

            const loadingEl = document.getElementById(`loading-${docId}`);
            if (loadingEl) loadingEl.style.display = 'none';

        } catch (e) {
            console.error(`Error generating thumbnail for ${docId}`, e);
            const canvas = document.getElementById(`thumb-${docId}`);
            if (canvas) {
                const parent = canvas.parentElement;
                parent.innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-file-pdf text-accent" style="font-size: 3rem;"></i></div>';
            }
        }
    }

    loadDashboard();
</script>